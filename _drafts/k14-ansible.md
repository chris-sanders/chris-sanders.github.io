---
layout: post
title:  "K14s with Ansible"
subtitle: "It's good enough"
#date:   2020-04-20 23:30:00 +0000
gh-repo: chris-sanders/ansible_k14_deployment
gh-badge: [star, fork, follow]
share-img: "/img/kubernetes/kubernetes_logo.svg"
image: "/img/kubernetes/kubernetes_logo.svg"
tags: [k8s, tools, homelab]
---

# Putting it all together
Currently I'm using Ansible to bring all of these tools together in an easily repeatable way.
It's a bit of a strange use case for Ansible but it works it's easy to update and has let me
test everything out with deployments. I may look to switch to other solutions to implement the
work flow later but this method is working for fast feedback on the overall process.

There is one primary Ansible role [ansible_k14][ansible_k14] which implements the work flow.
Each application has a role specific to the application which configures the application
specific values, templates, and overlays. The application roles are fairly small, and call
into the ansible_k14 role for task execution. If I stick with Ansible I'll be reviewing and
refactoring the ansible_k14 role so that all of the logic isn't in one large task.

The [repository linked to this post][k14_deployment] is a working example of these roles in
use deploying several applications on a test lab.

## Work flow
The work flow is designed to generate configurations to be checked into revision control. This
makes reviewing changes easy as both the input and resulting output can be seen in a diff.
Additionally everything needed to deploy or update an application is in the repository. Each
commit is a fully deployable configuration.
The steps that will be executed are:
 * Download/Update Helm repository
 * Generate kubernetes objects from repository
 * Generate any additional supporting objects from application role
 * Apply overlay modifications to resources if they are defined
 * Resolve image references to their digest form (immutable)
 * Write files to site/application specific folder for review and deployment

The process allows for multiple sites with site specific configuration as well as application
specific overlays if customization is needed on a per-site basis.

## Directory Structure
The final directory structure for a site and application will follow the following scheme:
```bash
sites/
└── site1
    ├── application
    │   ├── deploy.sh
    │   ├── diff.sh
    │   ├── manifest
    │   │   ├── ConfigMap.yaml
    │   │   ├── daemonset.yaml
    │   │   ├── deployment.yaml
    │   │   ├── namespace.yaml
    │   │   ├── rbac.yaml
    │   │   └── service-accounts.yaml
    │   ├── secrets
    │   │   └── secrets.yaml
    │   └── overlays
    │       └── manifest.yaml
    └── site.yaml
```
The role generates:
 * application folder
 * deploy and diff scripts
 * manifest folder populated with K8s objects
 * secrets folder with a secrets file (if used by the application role)

The site.yaml file is used for site specific settings and is not generated by the role.
The overlays folder and contents are not generated and are used to apply site specific
customizations to an application if they exist.




[ansible_k14]: https://github.com/chris-sanders/ansible_k14
